# Functions for predicting responses in MBNMAdose
# Author: Hugo Pedder
# Date created: 2019-04-25



#' Predict responses over time in a given population based on MBNMA time-course
#' models
#'
#' Used to predict responses over time for different treatments or to predict
#' the results of a new study. For MBNMA models that include consistency
#' relative effects on time-course parameters, this is calculated by combining
#' relative treatment effects with a given reference treatment response
#' (specific to the population of interest).
#'
#' Currently does not work with more complex time-course functions (piecelinear,
#' fract.poly.first, fract.poly.second)
#'
#' @param mbnma An S3 object of class `"MBNMA"` generated by running
#'   a time-course MBNMA model
#' @param times A sequence of positive numbers indicating which time points to
#'   predict mean responses for
#' @param baseline A value to use as baseline (time=0) for prediction. This can
#'   either be deterministic, specified by giving a single numeric value, or
#'   stochastic, specified by giving a character object that represents a random
#'   number generator (RNG). This can take any RNG distribution for which a
#'   function exists in R in which `n` is replaced with `nsims`. For
#'   example: `"rnorm(nsims, 7, 0.5)"`
#' @param treats A numeric vector of treatment codes (as coded in `mbnma`) that
#'   indicate which treatments to calculate predictions for. If left `NULL``
#'   then predictions will be calculated for all treatments.
#' @param ref.estimate A data frame containing data to be meta-analysed to estimate
#'   the network reference treatment effect. This could be an observational
#'   study/studies that are specific to the population on which to make
#'   predictions, or can be a subset of the study arms within the MBNMA dataset
#'   that investigate the network reference treatment.
#' @param synth A character object that can take the value `"fixed"` or `"random"` that
#'   specifies the the type of pooling to use for synthesis of `ref.estimate`. Using `"random"` rather
#'   than `"fixed"` for `synth` will result in wider 95\\% CrI for predictions.
#' @param ref.data A named list that contain parameter values that specify the
#'   network reference treatment response for parameters estimated using
#'   consistency relative effects (`pool="rel"`). Each element in the list
#'   is named with the corresponding time-course parameter in `mbnma`. Each
#'   element can be either deterministic (given a single numeric value) or
#'   stochastic (a character object that represents a random number generator
#'   (RNG). This can take any RNG distribution for which a function exists in R
#'   in which `n` is replaced with `nsims`. For example: `"rnorm(nsims, 7, 0.5)"`)
#' @param ... Arguments to be sent to R2jags for synthesis of the network
#'   reference treatment effect (using `ref.synth()`)
#'
#'
#' @return An S3 object of class `MBNMA.predict` that contains the following
#'   elements:
#'   * `summary` A named list of data frames. Each data frame contains
#'   a summary of predicted responses at follow-up times specified in `times`
#'   for each treatment specified in `treats`
#'   * `pred.mat` A named list of
#'   matrices. Each matrix contains the MCMC results of predicted responses at
#'   follow-up times specified in `times` for each treatment specified in
#'   `treats`
#'
#' @details `ref.estimate` or `ref.data` only need to be specified if `mbnma` has
#'   been estimated using consistency relative effects (`rel.common` or `rel.random`) for
#'   any time-course parameters, as these inform the absolute values of the
#'   network reference treatment parameters which can then be added to the
#'   relative effects to calculate specific predictions. In this case, only one
#'   or other of `ref.estimate` and `ref.data` should be specified.
#'
#' @examples
#' # Create an MBNMA.network object from a dataset
#' network <- MBNMA.network(osteopain)
#'
#' # Run an MBNMA model with an Emax time-course
#' emax <- MBNMA.emax(network,
#'   emax=list(pool="rel", method="common"),
#'   et50=list(pool="const", method="common"),
#'   positive.scale=TRUE)
#'
#' # Predict responses using a stochastic baseline and a distribution for the
#' #network reference treatment
#' preds <- predict(emax, times=c(0:10),
#'   baseline="rnorm(nsims, 7, 0.5)",
#'   ref.data=list("emax"="rnorm(nsims, -0.5, 0.05)"))
#' summary(preds)
#'
#' # Predict responses using the original dataset to estimate the network reference
#' #treatment response
#' paindata.ref <- paindata[paindata$treatname=="Placebo_0",]
#' preds <- predict(emax, times=c(5:15),
#'   baseline=10,
#'   ref.estimate=paindata.ref)
#' summary(preds)
#'
#' # Repeat the above prediction but using a random effects meta-analysis of the
#' #network reference treatment response
#' preds <- predict(emax, times=c(5:15),
#'   baseline=10,
#'   ref.estimate=paindata.ref,
#'   synth="random")
#' summary(preds)
#' @export
predict.MBNMA <- function(mbnma, doses=NULL, baseline=NULL,
                          ref.estimate=NULL, synth="fixed", ref.data=NULL,
                          ...) {
  ######## CHECKS ########

  # Run checks
  argcheck <- checkmate::makeAssertCollection()
  checkmate::assertClass(mbnma, "MBNMA", add=argcheck)
  checkmate::assertList(doses, null.ok=TRUE, add=argcheck)
  checkmate::assertChoice(synth, choices=c("random", "fixed"), add=argcheck)
  checkmate::assertIntegerish(treats, lower=0, any.missing=FALSE, unique=TRUE, null.ok=TRUE, add=argcheck)
  checkmate::assertList(ref.data, null.ok=TRUE, types=c("character", "numeric"), add=argcheck)
  checkmate::reportAssertions(argcheck)



  return(predict.result)
}
